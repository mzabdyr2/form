<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC Szalunki - Formularz Dzier≈ºawy</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            red: '#dc2626',
                            dark: '#1f2937',
                            gray: '#f3f4f6'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Subtelny wz√≥r t≈Ça a'la papier techniczny */
        body {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        /* Ukrywanie scrollbara dla estetyki w niekt√≥rych kontenerach */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Custom Input Styling Transition */
        .input-modern {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .radio-card-selected {
            border-color: #dc2626;
            background-color: #fef2f2;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1), 0 2px 4px -1px rgba(220, 38, 38, 0.06);
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen pb-12">

    <div class="h-2 w-full bg-gradient-to-r from-red-700 via-red-600 to-red-500 fixed top-0 z-50"></div>

    <header class="bg-white/90 backdrop-blur-md shadow-sm border-b border-slate-200 sticky top-0 z-40 mt-2">
        <div class="container mx-auto px-4 py-4 md:py-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-red-100 p-2 rounded-lg">
                    <div class="text-3xl">üèóÔ∏è</div>
                </div>
                <div class="text-left">
                    <div class="text-2xl font-bold text-slate-900 tracking-tight">ABC SZALUNKI</div>
                    <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Wynajem szalunk√≥w</div>
                </div>
            </div>
            <div class="text-center md:text-right">
                <h1 class="text-xl font-bold text-slate-800">Formularz Dzier≈ºawy</h1>
                <p class="text-sm text-slate-500">Za≈ÇƒÖcznik nr 4 - Dane Dzier≈ºawcy</p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 md:py-12">
        
        <form id="formularzForm" class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100" aria-describedby="formIntro" novalidate>
            
            <div class="bg-slate-50 px-8 py-6 border-b border-slate-100">
                <p id="formIntro" class="text-slate-600 text-sm">Wype≈Çnij poni≈ºsze dane, aby wygenerowaƒá umowƒô dzier≈ºawy. Pola oznaczone gwiazdkƒÖ (*) sƒÖ obowiƒÖzkowe.</p>
            </div>

            <div class="p-6 md:p-10 space-y-10">

                <fieldset id="clientTypeFieldset" class="space-y-4" aria-describedby="clientTypeError" aria-required="true">
                    <legend class="block text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Krok 1: Wybierz typ klienta *</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <label class="cursor-pointer group relative">
                            <input type="radio" id="clientTypeFirma" name="clientType" value="firma" class="peer sr-only" onchange="toggleClientType()" aria-describedby="clientTypeError" required>
                            <div class="p-6 rounded-xl border-2 border-slate-200 bg-white hover:border-red-300 transition-all duration-300 peer-checked:border-red-600 peer-checked:bg-red-50/50 peer-checked:shadow-lg flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-2xl group-hover:bg-red-100 transition-colors peer-checked:bg-red-100 peer-checked:text-red-600">
                                    üè¢
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 peer-checked:text-red-700">Firma</h3>
                                    <p class="text-sm text-slate-500">Sp√≥≈Çki, jednoosobowa dzia≈Çalno≈õƒá</p>
                                </div>
                                <div class="absolute top-6 right-6 w-6 h-6 border-2 border-slate-300 rounded-full peer-checked:border-red-600 peer-checked:bg-red-600 transition-all"></div>
                            </div>
                        </label>

                        <label class="cursor-pointer group relative">
                            <input type="radio" id="clientTypeOsoba" name="clientType" value="osoba" class="peer sr-only" onchange="toggleClientType()" aria-describedby="clientTypeError" required>
                            <div class="p-6 rounded-xl border-2 border-slate-200 bg-white hover:border-red-300 transition-all duration-300 peer-checked:border-red-600 peer-checked:bg-red-50/50 peer-checked:shadow-lg flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-2xl group-hover:bg-red-100 transition-colors peer-checked:bg-red-100 peer-checked:text-red-600">
                                    üë§
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 peer-checked:text-red-700">Osoba fizyczna</h3>
                                    <p class="text-sm text-slate-500">Klienci indywidualni</p>
                                </div>
                                <div class="absolute top-6 right-6 w-6 h-6 border-2 border-slate-300 rounded-full peer-checked:border-red-600 peer-checked:bg-red-600 transition-all"></div>
                            </div>
                        </label>
                    </div>
                    <p id="clientTypeError" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
                </fieldset>

                <hr class="border-slate-100">

                <div id="firmaSection" class="hidden animate-fade-in-down">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-red-600 text-white font-bold text-sm">1</span>
                        <h3 class="text-xl font-bold text-slate-800">Dane firmy</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="nipInput">NIP *</label>
                            <div class="relative">
                                <input type="text" name="nip" id="nipInput" onblur="pobierzDaneFirmyZGUS()" autocomplete="tax-id" inputmode="numeric" pattern="\\d{10}"
                                    class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern placeholder-slate-400" placeholder="np. 1234567890" aria-describedby="nipStatus nipError">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                                    üîç
                                </div>
                            </div>
                            <span id="nipStatus" class="text-xs text-slate-500 mt-1 block h-4" role="status" aria-live="polite"></span>
                            <span id="nipError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1">REGON</label>
                            <input type="text" name="regon" id="regonInput" readonly
                                class="w-full bg-slate-100 border border-slate-200 text-slate-500 text-sm rounded-lg focus:ring-0 focus:border-slate-200 block p-3 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1">KRS</label>
                            <input type="text" name="krs" id="krsInput" readonly
                                class="w-full bg-slate-100 border border-slate-200 text-slate-500 text-sm rounded-lg focus:ring-0 focus:border-slate-200 block p-3 cursor-not-allowed">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="authorizedPerson">Osoba upowa≈ºniona *</label>
                            <input type="text" name="authorizedPerson" id="authorizedPerson" autocomplete="name" aria-describedby="authorizedPersonError" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern" required>
                            <span id="authorizedPersonError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="companyPhone">Telefon *</label>
                            <input type="tel" name="phone" id="companyPhone" placeholder="+48 123 456 789" autocomplete="tel" inputmode="tel" aria-describedby="companyPhoneError" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern" required>
                            <span id="companyPhoneError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="invoiceEmail">E-mail do faktur *</label>
                        <input type="email" name="invoiceEmail" id="invoiceEmail" autocomplete="email" aria-describedby="invoiceEmailError" placeholder="np. faktury@firma.pl" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern" required>
                        <span id="invoiceEmailError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                    </div>

                    <div class="bg-slate-50/80 rounded-xl p-5 border border-slate-200/60">
                        <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                            Osoba wnioskujƒÖca (opcjonalne)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" name="applicantNameCompany" placeholder="Imiƒô i nazwisko" aria-label="Osoba wnioskujƒÖca - imiƒô i nazwisko" class="w-full bg-white border border-slate-200 text-sm rounded-lg p-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-colors">
                            <input type="tel" name="applicantPhoneCompany" placeholder="Telefon" aria-label="Osoba wnioskujƒÖca - telefon" class="w-full bg-white border border-slate-200 text-sm rounded-lg p-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-colors">
                            <input type="email" name="applicantEmailCompany" placeholder="E-mail" aria-label="Osoba wnioskujƒÖca - e-mail" class="w-full bg-white border border-slate-200 text-sm rounded-lg p-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-colors">
                        </div>
                    </div>
                </div>

                <div id="osobaSection" class="hidden animate-fade-in-down">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-red-600 text-white font-bold text-sm">1</span>
                        <h3 class="text-xl font-bold text-slate-800">Dane osoby fizycznej</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="fullName">Imiƒô i nazwisko *</label>
                            <input type="text" name="fullName" id="fullName" autocomplete="name" aria-describedby="fullNameError" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern" required>
                            <span id="fullNameError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="pesel">PESEL</label>
                            <input type="text" name="pesel" id="pesel" inputmode="numeric" pattern="\\d{11}" aria-describedby="peselError" placeholder="11 cyfr" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern">
                            <span id="peselError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="phonePrivate">Telefon *</label>
                            <input type="tel" name="phonePrivate" id="phonePrivate" autocomplete="tel" inputmode="tel" aria-describedby="phonePrivateError" placeholder="+48 123 456 789" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern" required>
                            <span id="phonePrivateError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="emailPrivate">E-mail *</label>
                            <input type="email" name="emailPrivate" id="emailPrivate" autocomplete="email" aria-describedby="emailPrivateError" placeholder="np. jan.kowalski@email.pl" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-3 input-modern" required>
                            <span id="emailPrivateError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                    </div>

                    <div class="bg-slate-50/80 rounded-xl p-5 border border-slate-200/60">
                        <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full"></span>
                            Osoba wnioskujƒÖca (opcjonalne)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" name="applicantName" placeholder="Imiƒô i nazwisko" aria-label="Osoba wnioskujƒÖca - imiƒô i nazwisko" class="w-full bg-white border border-slate-200 text-sm rounded-lg p-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-colors">
                            <input type="tel" name="applicantPhone" placeholder="Telefon" aria-label="Osoba wnioskujƒÖca - telefon" class="w-full bg-white border border-slate-200 text-sm rounded-lg p-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-colors">
                            <input type="email" name="applicantEmail" placeholder="E-mail" aria-label="Osoba wnioskujƒÖca - e-mail" class="w-full bg-white border border-slate-200 text-sm rounded-lg p-2.5 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-colors">
                        </div>
                    </div>
                </div>

                <fieldset id="regionFieldset" class="space-y-4" aria-describedby="regionError" aria-required="true">
                    <legend class="block text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Region inwestycji *</legend>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <label class="cursor-pointer group">
                            <input type="radio" id="regionKrakow" name="region" value="Krak√≥w" class="peer sr-only" aria-describedby="regionError" required>
                            <div class="p-4 rounded-lg border border-slate-200 hover:border-red-300 bg-white transition-all text-center peer-checked:border-red-600 peer-checked:bg-red-50 peer-checked:text-red-700">
                                <div class="text-2xl mb-2 grayscale group-hover:grayscale-0 peer-checked:grayscale-0 transition-all"></div>
                                <span class="font-semibold">Krak√≥w</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" id="regionSlask" name="region" value="≈ölƒÖsk" class="peer sr-only" aria-describedby="regionError" required>
                            <div class="p-4 rounded-lg border border-slate-200 hover:border-red-300 bg-white transition-all text-center peer-checked:border-red-600 peer-checked:bg-red-50 peer-checked:text-red-700">
                                <div class="text-2xl mb-2 grayscale group-hover:grayscale-0 peer-checked:grayscale-0 transition-all"></div>
                                <span class="font-semibold">≈ölƒÖsk</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" id="regionLodz" name="region" value="≈Å√≥d≈∫" class="peer sr-only" aria-describedby="regionError" required>
                            <div class="p-4 rounded-lg border border-slate-200 hover:border-red-300 bg-white transition-all text-center peer-checked:border-red-600 peer-checked:bg-red-50 peer-checked:text-red-700">
                                <div class="text-2xl mb-2 grayscale group-hover:grayscale-0 peer-checked:grayscale-0 transition-all"></div>
                                <span class="font-semibold">≈Å√≥d≈∫</span>
                            </div>
                        </label>
                    </div>
                    <p id="regionError" class="text-sm text-red-600 hidden" role="alert" aria-live="polite"></p>
                </fieldset>

                <section>
                    <div class="flex items-center gap-3 mb-6">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-white font-bold text-sm">2</span>
                        <h3 class="text-xl font-bold text-slate-800">Dane inwestycji</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="investmentName">Nazwa inwestycji *</label>
                            <input type="text" name="investmentName" id="investmentName" autocomplete="organization" aria-describedby="investmentNameError" placeholder="np. Budowa hali logistycznej" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern" required>
                            <span id="investmentNameError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="constructionAddress">Adres budowy *</label>
                            <input type="text" name="constructionAddress" id="constructionAddress" autocomplete="street-address" aria-describedby="constructionAddressError" placeholder="Ulica, numer, miasto" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern" required>
                            <span id="constructionAddressError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="startDate">Data rozpoczƒôcia *</label>
                            <input type="date" name="startDate" id="startDate" aria-describedby="startDateError" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern" required>
                            <span id="startDateError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="rentalPeriod">Przewidywany okres *</label>
                            <div class="relative">
                                <select name="rentalPeriod" id="rentalPeriod" aria-describedby="rentalPeriodError" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 appearance-none input-modern" required>
                                    <option value="">Wybierz okres</option>
                                    <option value="8 dni">8 dni</option>
                                    <option value="10-15 dni">10-15 dni</option>
                                    <option value="15-30 dni">15-30 dni</option>
                                    <option value="30-60 dni">30-60 dni</option>
                                    <option value="60 dni i wiƒôcej">60 dni i wiƒôcej</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                            <span id="rentalPeriodError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                    </div>
                </section>

                <hr class="border-slate-100">

                <section>
                    <div class="flex items-center gap-3 mb-6">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-white font-bold text-sm">3</span>
                        <h3 class="text-xl font-bold text-slate-800">Wykonawca</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="contractorName">Nazwa wykonawcy *</label>
                            <input type="text" name="contractorName" id="contractorName" aria-describedby="contractorNameError" placeholder="np. Firma budowlana XYZ" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern" required>
                            <span id="contractorNameError" class="text-xs text-red-600 mt-1 block hidden" role="alert" aria-live="polite"></span>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="contactPerson">Osoba kontaktowa</label>
                            <input type="text" name="contactPerson" id="contactPerson" autocomplete="name" placeholder="Imiƒô i nazwisko" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="contractorPhone">Telefon</label>
                            <input type="tel" name="contractorPhone" id="contractorPhone" autocomplete="tel" placeholder="+48 123 456 789" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="constructionPhone">Telefon na budowƒô</label>
                            <input type="tel" name="constructionPhone" id="constructionPhone" autocomplete="tel" placeholder="+48 123 456 789" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="contractorNotes">Dodatkowe informacje</label>
                        <textarea name="contractorNotes" id="contractorNotes" rows="2" placeholder="Np. preferowane godziny kontaktu" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern transition-all"></textarea>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <section class="bg-white border border-slate-100 rounded-xl p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-700 font-bold text-xs">4</span>
                            <h3 class="text-lg font-bold text-slate-700">Inwestor</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="text" name="investorName" placeholder="Nazwa inwestora" aria-label="Nazwa inwestora" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            <input type="text" name="investorNip" placeholder="NIP" aria-label="NIP inwestora" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="tel" name="investorPhone" placeholder="Telefon" aria-label="Telefon inwestora" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                                <input type="email" name="investorEmail" placeholder="E-mail" aria-label="E-mail inwestora" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            </div>
                        </div>
                    </section>

                    <section class="bg-white border border-slate-100 rounded-xl p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-700 font-bold text-xs">5</span>
                            <h3 class="text-lg font-bold text-slate-700">Generalny Wykonawca</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="text" name="generalContractorName" placeholder="Nazwa GW" aria-label="Nazwa generalnego wykonawcy" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            <input type="text" name="generalContractorNip" placeholder="NIP GW" aria-label="NIP generalnego wykonawcy" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            <input type="tel" name="generalContractorPhone" placeholder="Telefon" aria-label="Telefon generalnego wykonawcy" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                        </div>
                    </section>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                     <section class="bg-white border border-slate-100 rounded-xl p-5 shadow-sm">
                         <div class="flex items-center gap-3 mb-4">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-700 font-bold text-xs">6</span>
                            <h3 class="text-lg font-bold text-slate-700">Kierownik budowy</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="text" name="constructionManagerName" placeholder="Imiƒô i nazwisko" aria-label="Kierownik budowy - imiƒô i nazwisko" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="tel" name="constructionManagerPhone" placeholder="Telefon" aria-label="Kierownik budowy - telefon" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                                <input type="email" name="constructionManagerEmail" placeholder="E-mail" aria-label="Kierownik budowy - e-mail" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none">
                            </div>
                        </div>
                    </section>

                    <section class="bg-white border border-slate-100 rounded-xl p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-700 font-bold text-xs">7</span>
                            <h3 class="text-lg font-bold text-slate-700">Uwagi / Zapotrzebowanie</h3>
                        </div>
                        <textarea name="requirements" rows="4" placeholder="Opisz potrzeby..." aria-label="Uwagi lub zapotrzebowanie" class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg p-3 focus:ring-slate-800 focus:border-slate-800 outline-none resize-none"></textarea>
                    </section>
                </div>

                <section>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1" for="contactSource">8. SkƒÖd kontakt do ABC Szalunki</label>
                    <input type="text" name="contactSource" id="contactSource" placeholder="np. strona internetowa, polecenie, reklama" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-slate-800 focus:border-slate-800 block p-3 input-modern">
                </section>

                <div class="bg-slate-50 rounded-xl p-6 border border-slate-100">
                    <h4 class="font-bold text-slate-800 mb-3 text-sm flex items-center gap-2">
                        üõ°Ô∏è Informacja o przetwarzaniu danych osobowych (RODO)
                    </h4>
                    <div class="text-xs text-slate-500 space-y-2 h-32 overflow-y-auto pr-2 custom-scrollbar border-b border-slate-200 pb-4 mb-4 leading-relaxed">
                        <p>Zgodnie z ustawƒÖ odno≈õnie ochrony danych osobowych oraz RozporzƒÖdzenia Parlamentu Europejskiego i Rady (UE) 2016/679 Administratorem Danych Osobowych (ADO) jest Grupa ABC szalunki reprezentowana przez: ABC Szalunki Zbigniew Szarawarski NIP: 6791745313, Maciej Szarawarski PHU PRATA NIP: 6762382380, PRATA Sp. z o. o. NIP 6762599837.</p>
                        <p>Dane przetwarzane sƒÖ w celu: przedstawienia oferty umowy, realizacji zawartej umowy, dzia≈Ça≈Ñ marketingu bezpo≈õredniego oferowanych przez ADO us≈Çug. Odbiorcami udostƒôpnionych danych osobowych bƒôdzie wy≈ÇƒÖcznie ADO oraz podmioty wsp√≥≈ÇpracujƒÖce.</p>
                        <p>Podanie danych jest dobrowolne, jednak brak ich udostƒôpnienia skutkuje brakiem mo≈ºliwo≈õci realizacji zawartej z ADO Umowy.</p>
                    </div>

                    <label class="flex items-start cursor-pointer group">
                        <div class="relative flex items-center">
                            <input type="checkbox" name="dataConsent" id="dataConsent" required class="peer sr-only" aria-describedby="dataConsentError">
                            <div class="w-5 h-5 border-2 border-slate-300 rounded bg-white peer-checked:bg-red-600 peer-checked:border-red-600 transition-all"></div>
                            <svg class="absolute w-3 h-3 text-white hidden peer-checked:block left-1 top-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </div>
                        <span class="ml-3 text-xs text-slate-600 group-hover:text-slate-800 transition-colors">Potwierdzam zgodno≈õƒá danych do umowy i wyra≈ºam zgodƒô na przetwarzanie moich danych osobowych zgodnie z powy≈ºszƒÖ informacjƒÖ. *</span>
                    </label>
                    <p id="dataConsentError" class="text-xs text-red-600 mt-2 hidden" role="alert" aria-live="polite"></p>
                </div>

                <div id="statusMessage" class="hidden p-4 rounded-lg text-sm font-medium text-center" role="status" aria-live="polite"></div>

                <div class="pt-4 pb-2 text-center">
                    <button type="submit" id="submitButton"
                        class="group relative inline-flex items-center justify-center px-10 py-4 text-lg font-bold text-white transition-all duration-200 bg-gradient-to-r from-red-600 to-red-700 rounded-xl hover:from-red-500 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600 shadow-lg shadow-red-600/30 hover:shadow-red-600/40 hover:-translate-y-1 w-full md:w-auto">
                        <span class="mr-2">üìÑ</span>
                        Wy≈õlij formularz
                        <svg class="w-5 h-5 ml-2 -mr-1 transition-transform duration-200 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                    <p class="mt-4 text-xs text-slate-400">Po klikniƒôciu zostanie wygenerowany dokument PDF.</p>
                </div>

            </div>
        </form>
    </main>

    <footer class="text-center text-slate-400 text-xs py-8">
        &copy; 2026 ABC Szalunki. Wszelkie prawa zastrze≈ºone.
    </footer>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-IlRE0Vs4UyCZDiptLbhxhz1IHloUmvlERLjbE_voqJZhgZn7TumrGu022LjlaQGkFA/exec';
        const SHEET_ID = '117ZPtH4-2vgDPQh-tInjyjI9GE5xN82evgVFikvcNFQ';
        
        // ==========================================
        // FUNKCJA POBIERANIA DANYCH FIRMY Z GUS API
        // ==========================================
        async function pobierzDaneFirmyZGUS() {
            const nipInput = document.getElementById('nipInput');
            const regonInput = document.getElementById('regonInput');
            const krsInput = document.getElementById('krsInput');
            const nipStatus = document.getElementById('nipStatus');
            const nipError = document.getElementById('nipError');
            if (nipError) {
                nipError.textContent = '';
                nipError.classList.add('hidden');
            }
            
            // Pobierz i wyczy≈õƒá NIP
            let nip = nipInput.value.replace(/[-\s]/g, '');
            nip = sanitizeValue(nip);
            nipInput.value = nip;
            
            // Walidacja NIP
            if (!nip || nip.length === 0) {
                return;
            }
            
            if (!/^\d{10}$/.test(nip)) {
                nipStatus.textContent = '‚ö†Ô∏è NIP musi sk≈Çadaƒá siƒô z 10 cyfr';
                nipStatus.className = 'text-xs text-red-600';
                setFieldError(FIELD_CONFIG.nip, 'NIP musi sk≈Çadaƒá siƒô z 10 cyfr.');
                return;
            }
            
            // Poka≈º status ≈Çadowania i zablokuj pola
            nipStatus.textContent = 'Pobieranie danych...';
            nipStatus.className = 'text-xs text-blue-600';
            regonInput.value = '';
            krsInput.value = '';
            regonInput.setAttribute('readonly', 'readonly');
            regonInput.classList.add('bg-gray-50');
            krsInput.setAttribute('readonly', 'readonly');
            krsInput.classList.add('bg-gray-50');
            
            try {
                // Metoda 1: Pr√≥ba przez fetch z timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 sekund
                
                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=getCompanyData&nip=${nip}`, {
                        method: 'GET',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        nipStatus.textContent = '‚ö†Ô∏è ' + data.error;
                        nipStatus.className = 'text-xs text-red-600';
                        odblokujPolaDoRecznegoWprowadzenia();
                        return;
                    }
                    
                    if (data.success) {
                        // Sprawd≈∫ czy REGON i KRS sƒÖ rzeczywi≈õcie wype≈Çnione
                        const hasRegon = data.regon && data.regon.trim() !== '';
                        const hasKrs = data.krs && data.krs.trim() !== '';
                        
                        // Uzupe≈Çnij pola REGON i KRS
                        regonInput.value = data.regon || '';
                        krsInput.value = data.krs || '';
                        
                        // Je≈õli brak REGON lub KRS - odblokuj pola
                        if (!hasRegon && !hasKrs) {
                            let statusText = 'Zweryfikuj dane ';
                            statusText += ' - uzupe≈Çnij rƒôcznie';
                            
                            if (data.nazwa) {
                                statusText += ` (${data.nazwa.substring(0, 40)}...)`;
                            }
                            
                            nipStatus.textContent = statusText;
                            nipStatus.className = 'text-xs text-orange-600';
                            odblokujPolaDoRecznegoWprowadzenia();
                            return;
                        }
                        
                        // Pe≈Çny sukces - wszystkie dane pobrane
                        let statusText = 'Dane pobrane';
                        if (data.nazwa) {
                            statusText += ` (${data.nazwa.substring(0, 50)}${data.nazwa.length > 50 ? '...' : ''})`;
                        }
                        nipStatus.textContent = statusText;
                        nipStatus.className = 'text-xs text-green-600';
                        return;
                    }
                    
                    nipStatus.textContent = '‚ö†Ô∏è Nie znaleziono firmy o podanym NIP - wprowad≈∫ dane rƒôcznie';
                    nipStatus.className = 'text-xs text-orange-600';
                    odblokujPolaDoRecznegoWprowadzenia();
                    
                } catch (fetchError) {
                    // Je≈õli fetch nie zadzia≈Ça≈Ç, spr√≥buj JSONP
                    console.log('Fetch failed, trying JSONP...', fetchError);
                    
                    const callbackName = 'gusCallback_' + Date.now();
                    const url = `${APPS_SCRIPT_URL}?action=getCompanyData&nip=${nip}&callback=${callbackName}`;
                    
                    const dataPromise = new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            cleanup();
                            reject(new Error('JSONP Timeout'));
                        }, 20000);
                        
                        window[callbackName] = function(data) {
                            clearTimeout(timeout);
                            cleanup();
                            resolve(data);
                        };
                        
                        const cleanup = () => {
                            delete window[callbackName];
                            if (script && script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        };
                    });
                    
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = () => {
                        throw new Error('Script load error');
                    };
                    document.body.appendChild(script);
                    
                    const data = await dataPromise;
                    
                    if (data.error) {
                        nipStatus.textContent = '‚ö†Ô∏è ' + data.error;
                        nipStatus.className = 'text-xs text-red-600';
                        odblokujPolaDoRecznegoWprowadzenia();
                        return;
                    }
                    
                    if (data.success) {
                        // Sprawd≈∫ czy REGON i KRS sƒÖ rzeczywi≈õcie wype≈Çnione
                        const hasRegon = data.regon && data.regon.trim() !== '';
                        const hasKrs = data.krs && data.krs.trim() !== '';
                        
                        regonInput.value = data.regon || '';
                        krsInput.value = data.krs || '';
                        
                        // Je≈õli brak REGON lub KRS - odblokuj pola
                        if (!hasRegon || !hasKrs) {
                            let statusText = '‚ö†Ô∏è NIP zweryfikowany, ale brak ';
                            if (!hasRegon && !hasKrs) {
                                statusText += 'REGON i KRS';
                            } else if (!hasRegon) {
                                statusText += 'REGON';
                            } else {
                                statusText += 'KRS';
                            }
                            statusText += ' - uzupe≈Çnij rƒôcznie';
                            
                            if (data.nazwa) {
                                statusText += ` (${data.nazwa.substring(0, 40)}...)`;
                            }
                            
                            nipStatus.textContent = statusText;
                            nipStatus.className = 'text-xs text-orange-600';
                            odblokujPolaDoRecznegoWprowadzenia();
                            return;
                        }
                        
                        let statusText = '‚úÖ Dane pobrane z GUS';
                        if (data.nazwa) {
                            statusText += ` (${data.nazwa.substring(0, 50)}${data.nazwa.length > 50 ? '...' : ''})`;
                        }
                        nipStatus.textContent = statusText;
                        nipStatus.className = 'text-xs text-green-600';
                    } else {
                        nipStatus.textContent = '‚ö†Ô∏è Nie znaleziono firmy o podanym NIP - wprowad≈∫ dane rƒôcznie';
                        nipStatus.className = 'text-xs text-orange-600';
                        odblokujPolaDoRecznegoWprowadzenia();
                    }
                }
                
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania danych GUS:', error);
                nipStatus.textContent = '‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia - wprowad≈∫ dane rƒôcznie';
                nipStatus.className = 'text-xs text-red-600';
                odblokujPolaDoRecznegoWprowadzenia();
            }
        }

        function odblokujPolaDoRecznegoWprowadzenia() {
            const regonInput = document.getElementById('regonInput');
            const krsInput = document.getElementById('krsInput');

            regonInput.removeAttribute('readonly');
            regonInput.classList.remove('bg-gray-50');
            regonInput.classList.remove('cursor-not-allowed'); // Usuniƒôcie klasy kursora
            regonInput.classList.add('bg-white'); // Dodanie t≈Ça bia≈Çego
            
            krsInput.removeAttribute('readonly');
            krsInput.classList.remove('bg-gray-50');
            krsInput.classList.remove('cursor-not-allowed');
            krsInput.classList.add('bg-white');
        }

        // Pobierz dane po naci≈õniƒôciu Enter w polu NIP
        document.addEventListener('DOMContentLoaded', function () {
            const nipInput = document.getElementById('nipInput');
            if (nipInput) {
                nipInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        pobierzDaneFirmyZGUS();
                    }
                });
            }
            const form = document.getElementById('formularzForm');
            if (form) {
                form.addEventListener('submit', submitForm);
            }
            attachFieldListeners();
        });

        function toggleClientType() {
            const clientType = document.querySelector('input[name="clientType"]:checked')?.value;
            const firmaSection = document.getElementById('firmaSection');
            const osobaSection = document.getElementById('osobaSection');

            if (clientType === 'firma') {
                firmaSection.classList.remove('hidden');
                osobaSection.classList.add('hidden');
            } else if (clientType === 'osoba') {
                osobaSection.classList.remove('hidden');
                firmaSection.classList.add('hidden');
            }

            validateField('clientType', clientType, clientType);
            validateField('nip', sanitizeValue(document.getElementById('nipInput')?.value || ''), clientType);
            validateField('authorizedPerson', sanitizeValue(document.getElementById('authorizedPerson')?.value || ''), clientType);
            validateField('phone', sanitizeValue(document.getElementById('companyPhone')?.value || ''), clientType);
            validateField('invoiceEmail', sanitizeValue(document.getElementById('invoiceEmail')?.value || ''), clientType);
            validateField('fullName', sanitizeValue(document.getElementById('fullName')?.value || ''), clientType);
            validateField('pesel', sanitizeValue(document.getElementById('pesel')?.value || ''), clientType);
            validateField('phonePrivate', sanitizeValue(document.getElementById('phonePrivate')?.value || ''), clientType);
            validateField('emailPrivate', sanitizeValue(document.getElementById('emailPrivate')?.value || ''), clientType);
        }

        const PHONE_PATTERN = /^[+\d][\d\s-]{8,}$/;
        const EMAIL_PATTERN = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const TEXT_SANITIZE_PATTERN = /[<>"'&]/g;

        const FIELD_CONFIG = {
            clientType: {
                fieldsetId: 'clientTypeFieldset',
                errorId: 'clientTypeError',
                required: true,
                message: 'Wybierz typ klienta.'
            },
            region: {
                fieldsetId: 'regionFieldset',
                errorId: 'regionError',
                required: true,
                message: 'Wybierz region inwestycji.'
            },
            nip: {
                inputId: 'nipInput',
                errorId: 'nipError',
                required: true,
                pattern: /^\d{10}$/,
                message: 'Wpisz NIP firmy (10 cyfr).'
            },
            authorizedPerson: {
                inputId: 'authorizedPerson',
                errorId: 'authorizedPersonError',
                required: true,
                message: 'Wpisz osobƒô upowa≈ºnionƒÖ.'
            },
            phone: {
                inputId: 'companyPhone',
                errorId: 'companyPhoneError',
                required: true,
                pattern: PHONE_PATTERN,
                message: 'Podaj poprawny numer telefonu.'
            },
            invoiceEmail: {
                inputId: 'invoiceEmail',
                errorId: 'invoiceEmailError',
                required: true,
                pattern: EMAIL_PATTERN,
                message: 'Podaj poprawny adres e-mail.'
            },
            fullName: {
                inputId: 'fullName',
                errorId: 'fullNameError',
                required: true,
                message: 'Wpisz imiƒô i nazwisko.'
            },
            pesel: {
                inputId: 'pesel',
                errorId: 'peselError',
                pattern: /^\d{11}$/,
                message: 'PESEL musi mieƒá 11 cyfr.'
            },
            phonePrivate: {
                inputId: 'phonePrivate',
                errorId: 'phonePrivateError',
                required: true,
                pattern: PHONE_PATTERN,
                message: 'Podaj poprawny numer telefonu.'
            },
            emailPrivate: {
                inputId: 'emailPrivate',
                errorId: 'emailPrivateError',
                required: true,
                pattern: EMAIL_PATTERN,
                message: 'Podaj poprawny adres e-mail.'
            },
            investmentName: {
                inputId: 'investmentName',
                errorId: 'investmentNameError',
                required: true,
                message: 'Wpisz nazwƒô inwestycji.'
            },
            constructionAddress: {
                inputId: 'constructionAddress',
                errorId: 'constructionAddressError',
                required: true,
                message: 'Wpisz adres budowy.'
            },
            startDate: {
                inputId: 'startDate',
                errorId: 'startDateError',
                required: true,
                message: 'Wybierz datƒô rozpoczƒôcia.'
            },
            rentalPeriod: {
                inputId: 'rentalPeriod',
                errorId: 'rentalPeriodError',
                required: true,
                message: 'Wybierz przewidywany okres.'
            },
            contractorName: {
                inputId: 'contractorName',
                errorId: 'contractorNameError',
                required: true,
                message: 'Wpisz nazwƒô wykonawcy.'
            },
            dataConsent: {
                inputId: 'dataConsent',
                errorId: 'dataConsentError',
                required: true,
                message: 'Musisz wyraziƒá zgodƒô na przetwarzanie danych osobowych.'
            }
        };

        function sanitizeValue(value) {
            if (typeof value !== 'string') return value;
            return value.replace(TEXT_SANITIZE_PATTERN, '').trim();
        }

        function setFieldError(config, message = '') {
            if (config.fieldsetId) {
                const fieldset = document.getElementById(config.fieldsetId);
                if (fieldset) {
                    fieldset.setAttribute('aria-invalid', message ? 'true' : 'false');
                }
            }

            if (config.inputId) {
                const input = document.getElementById(config.inputId);
                if (input) {
                    input.setAttribute('aria-invalid', message ? 'true' : 'false');
                }
            }

            if (config.errorId) {
                const errorEl = document.getElementById(config.errorId);
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.toggle('hidden', !message);
                }
            }
        }

        function getClientType() {
            return document.querySelector('input[name="clientType"]:checked')?.value;
        }

        function validateField(key, value, clientType) {
            const config = FIELD_CONFIG[key];
            if (!config) return true;

            if (key === 'nip') {
                if (clientType !== 'firma') {
                    setFieldError(config);
                    return true;
                }
                if (!value) {
                    setFieldError(config, config.message);
                    return false;
                }
            }

            if (['authorizedPerson', 'phone', 'invoiceEmail'].includes(key) && clientType !== 'firma') {
                setFieldError(config);
                return true;
            }

            if (['fullName', 'phonePrivate', 'emailPrivate', 'pesel'].includes(key) && clientType !== 'osoba') {
                setFieldError(config);
                return true;
            }

            if (config.required && !value) {
                setFieldError(config, config.message);
                return false;
            }

            if (value && config.pattern && !config.pattern.test(value)) {
                setFieldError(config, config.message);
                return false;
            }

            setFieldError(config);
            return true;
        }

        function validateForm(formData) {
            const clientType = formData.clientType;
            const errors = [];

            Object.keys(FIELD_CONFIG).forEach((key) => {
                const value = formData[key];
                const isValid = validateField(key, value, clientType);
                if (!isValid && FIELD_CONFIG[key].message) {
                    errors.push(FIELD_CONFIG[key].message);
                }
            });

            return {
                isValid: errors.length === 0,
                errors
            };
        }

        function attachFieldListeners() {
            Object.values(FIELD_CONFIG).forEach((config) => {
                if (config.inputId) {
                    const input = document.getElementById(config.inputId);
                    if (input) {
                        input.addEventListener('input', () => {
                            const clientType = getClientType();
                            const value = sanitizeValue(input.value);
                            if (input.value !== value) {
                                input.value = value;
                            }
                            validateField(input.name, value, clientType);
                        });
                        input.addEventListener('blur', () => {
                            const clientType = getClientType();
                            validateField(input.name, sanitizeValue(input.value), clientType);
                        });
                        if (input.type === 'checkbox') {
                            input.addEventListener('change', () => {
                                const clientType = getClientType();
                                validateField(input.name, input.checked ? input.value : '', clientType);
                            });
                        }
                    }
                }
            });

            ['clientType', 'region'].forEach((name) => {
                document.querySelectorAll(`input[name="${name}"]`).forEach((input) => {
                    input.addEventListener('change', () => {
                        const clientType = getClientType();
                        validateField(name, sanitizeValue(input.value), clientType);
                    });
                });
            });
        }

        function collectFormData() {
            const formData = {};
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    if (input.checked) formData[input.name] = sanitizeValue(input.value);
                } else {
                    formData[input.name] = sanitizeValue(input.value || '');
                }
            });
            return formData;
        }

        // ==========================================
        // FUNKCJA GENEROWANIA PDF - PDFMAKE Z POLSKIMI ZNAKAMI
        // ==========================================
        function createPDFWithNativeText(formData) {
            const content = [];

            // HEADER - czerwone t≈Ço
            content.push({
                table: {
                    widths: ['*'],
                    body: [
                        [{ text: 'ABC SZALUNKI', style: 'header', alignment: 'center', fillColor: '#dc2626', color: '#ffffff', margin: [0, 10, 0, 5] }],
                        [{ text: 'FORMULARZ DZIER≈ªAWY', style: 'subheader', alignment: 'center', fillColor: '#dc2626', color: '#ffffff', margin: [0, 0, 0, 5] }],
                        [{ text: 'Za≈ÇƒÖcznik nr 4 - Dane kontaktowe Dzier≈ºawcy', alignment: 'center', fillColor: '#dc2626', color: '#ffffff', margin: [0, 0, 0, 10] }]
                    ]
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 20]
            });

            // Funkcja dodawania sekcji
            function addSection(title) {
                content.push({
                    text: title,
                    style: 'sectionHeader',
                    margin: [0, 10, 0, 5]
                });
                content.push({
                    canvas: [
                        {
                            type: 'line',
                            x1: 0, y1: 0,
                            x2: 515, y2: 0,
                            lineWidth: 1,
                            lineColor: '#dc2626'
                        }
                    ],
                    margin: [0, 0, 0, 10]
                });
            }

            // Funkcja dodawania pola
            function addField(label, value) {
                if (!value) return;
                content.push({
                    text: [
                        { text: label + ':\n', bold: true, fontSize: 9, color: '#3c3c3c' },
                        { text: value + '\n', fontSize: 9 }
                    ],
                    margin: [0, 2, 0, 4]
                });
            }

            // TYP DZIER≈ªAWCY
            addSection('TYP DZIER≈ªAWCY');
            const clientTypeText = formData.clientType === 'firma' ? 'Firma' :
                formData.clientType === 'osoba' ? 'Osoba fizyczna' : 'Nie wybrano';
            addField('Wybrany typ', clientTypeText);
            addField('Region', formData.region || 'Nie wybrano');

            // DANE FIRMY
            if (formData.clientType === 'firma') {
                addSection('1. DANE DZIER≈ªAWCY - FIRMA');
                addField('NIP', formData.nip);
                addField('REGON', formData.regon);
                addField('KRS', formData.krs);
                addField('Telefon', formData.phone);
                addField('E-mail do faktur', formData.invoiceEmail);

                if (formData.applicantNameCompany || formData.applicantPhoneCompany || formData.applicantEmailCompany) {
                    content.push({ text: 'Osoba wnioskujƒÖca (je≈õli inna ni≈º dzier≈ºawca):', bold: true, margin: [0, 5, 0, 3], color: '#666666' });
                    addField('Imiƒô i nazwisko', formData.applicantNameCompany);
                    addField('Telefon', formData.applicantPhoneCompany);
                    addField('E-mail', formData.applicantEmailCompany);
                }
            }

            // DANE OSOBY FIZYCZNEJ
            if (formData.clientType === 'osoba') {
                addSection('1. DANE DZIER≈ªAWCY - OSOBA FIZYCZNA');
                addField('Imiƒô i nazwisko', formData.fullName);
                addField('PESEL', formData.pesel);
                addField('Telefon', formData.phonePrivate);
                addField('E-mail', formData.emailPrivate);

                if (formData.applicantName || formData.applicantPhone || formData.applicantEmail) {
                    content.push({ text: 'Osoba wnioskujƒÖca (je≈õli inna ni≈º dzier≈ºawca):', bold: true, margin: [0, 5, 0, 3], color: '#666666' });
                    addField('Imiƒô i nazwisko', formData.applicantName);
                    addField('Telefon', formData.applicantPhone);
                    addField('E-mail', formData.applicantEmail);
                }
            }

            // INWESTYCJA
            addSection('2. INWESTYCJA');
            addField('Nazwa inwestycji', formData.investmentName);
            addField('Adres budowy', formData.constructionAddress);
            addField('Data rozpoczƒôcia', formData.startDate);
            addField('Przewidywany okres dzier≈ºawy', formData.rentalPeriod);

            // WYKONAWCA
            addSection('3. WYKONAWCA');
            addField('Nazwa wykonawcy', formData.contractorName);
            addField('Osoba kontaktowa', formData.contactPerson);
            addField('Telefon kontaktowy', formData.contractorPhone);
            addField('Telefon na budowƒô', formData.constructionPhone);
            addField('Dodatkowe informacje', formData.contractorNotes);

            // INWESTOR
            if (formData.investorName || formData.investorNip || formData.investorPhone || formData.investorEmail) {
                addSection('4. INWESTOR');
                addField('Nazwa inwestora', formData.investorName);
                addField('NIP inwestora', formData.investorNip);
                addField('Telefon', formData.investorPhone);
                addField('E-mail', formData.investorEmail);
            }

            // GENERALNY WYKONAWCA
            if (formData.generalContractorName || formData.generalContractorNip || formData.generalContractorPhone) {
                addSection('5. GENERALNY WYKONAWCA');
                addField('Nazwa generalnego wykonawcy', formData.generalContractorName);
                addField('NIP generalnego wykonawcy', formData.generalContractorNip);
                addField('Telefon', formData.generalContractorPhone);
            }

            // KIEROWNIK BUDOWY
            if (formData.constructionManagerName || formData.constructionManagerPhone || formData.constructionManagerEmail) {
                addSection('6. KIEROWNIK BUDOWY');
                addField('Imiƒô i nazwisko', formData.constructionManagerName);
                addField('Telefon', formData.constructionManagerPhone);
                addField('E-mail', formData.constructionManagerEmail);
            }

            // UWAGI
            if (formData.requirements) {
                addSection('7. UWAGI/OPIS ZAPOTRZEBOWANIA');
                addField('Opis', formData.requirements);
            }

            // ≈πR√ìD≈ÅO KONTAKTU
            if (formData.contactSource) {
                addSection('8. ≈πR√ìD≈ÅO KONTAKTU DO ABC SZALUNKI');
                addField('SkƒÖd kontakt', formData.contactSource);
            }

            // ZGODA RODO
            addSection('ZGODA RODO');
            const rodoStatus = formData.dataConsent ? 'WYRA≈ªONA' : 'NIE WYRA≈ªONA';
            addField('Status zgody na przetwarzanie danych osobowych', rodoStatus);

            content.push({
                text: 'Administrator danych: Grupa ABC szalunki\n(ABC Szalunki Zbigniew Szarawarski, Maciej Szarawarski PHU PRATA, PRATA Sp. z o.o.)',
                fontSize: 8,
                color: '#666666',
                margin: [0, 5, 0, 0]
            });

            // Definicja dokumentu
            const docDefinition = {
                content: content,
                styles: {
                    header: {
                        fontSize: 24,
                        bold: true
                    },
                    subheader: {
                        fontSize: 14,
                        bold: true
                    },
                    sectionHeader: {
                        fontSize: 12,
                        bold: true,
                        color: '#dc2626'
                    }
                },
                footer: function (currentPage, pageCount) {
                    return {
                        stack: [
                            {
                                canvas: [
                                    {
                                        type: 'line',
                                        x1: 0, y1: 0,
                                        x2: 515, y2: 0,
                                        lineWidth: 0.5,
                                        lineColor: '#cccccc'
                                    }
                                ],
                                margin: [40, 0, 40, 5]
                            },
                            {
                                text: 'ABC Szalunki | ul. Skotnicka 272, 30-394 Krak√≥w | NIP: 6762382380',
                                alignment: 'center',
                                fontSize: 8,
                                color: '#666666',
                                margin: [0, 0, 0, 2]
                            },
                            {
                                text: 'www.abcszalunki.pl | Data: ' + new Date().toLocaleDateString('pl-PL') + ' | Strona ' + currentPage + ' / ' + pageCount,
                                alignment: 'center',
                                fontSize: 8,
                                color: '#666666'
                            }
                        ],
                        margin: [0, 10, 0, 0]
                    };
                },
                pageMargins: [40, 60, 40, 60],
                defaultStyle: {
                    font: 'Roboto'
                }
            };

            // Zwr√≥ƒá obiekt z metodami
            return {
                save: function (filename) {
                    const docDefinitionCopy = JSON.parse(JSON.stringify(docDefinition));
                    pdfMake.createPdf(docDefinitionCopy).download(filename);
                },
                getBase64: function () {
                    return new Promise((resolve) => {
                        const docDefinitionCopy = JSON.parse(JSON.stringify(docDefinition));
                        pdfMake.createPdf(docDefinitionCopy).getBase64((data) => {
                            resolve('data:application/pdf;base64,' + data);
                        });
                    });
                }
            };
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100', 'text-green-800', 'text-red-800', 'text-blue-800');

            if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
            }

            statusEl.textContent = message;
        }

        async function submitForm(event) {
            event?.preventDefault();
            const button = document.getElementById('submitButton');
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Przetwarzanie...';
            button.disabled = true;

            try {
                const formData = collectFormData();
                const validation = validateForm(formData);

                if (!validation.isValid) {
                    const firstErrorField = document.querySelector('[aria-invalid="true"]');
                    const focusTarget = firstErrorField?.matches('fieldset')
                        ? firstErrorField.querySelector('input')
                        : firstErrorField;
                    focusTarget?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    focusTarget?.focus();
                    throw new Error(validation.errors[0] || 'Nieprawid≈Çowe dane w formularzu.');
                }

                showStatus('üìÑ Generowanie PDF z polskimi znakami (ƒÖ, ƒá, ƒô, ≈Ç, ≈Ñ, √≥, ≈õ, ≈∫, ≈º)...', 'info');

                const doc = createPDFWithNativeText(formData);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `ABC_Szalunki_Formularz_${timestamp}.pdf`;

                // Pobierz PDF lokalnie
                doc.save(filename);
                showStatus('‚úÖ Formularz zosta≈Ç pobrany w PDF! Wysy≈Çanie do systemu...', 'success');

                // Pobierz base64 dla uploadu
                const pdfBase64 = await doc.getBase64();

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdfBase64: pdfBase64,
                        filename: filename,
                        formData: formData
                    })
                });


                showStatus('‚úÖ Wys≈Çano formularz! Dziƒôkujemy.', 'success');

            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                showStatus('‚ö†Ô∏è ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
    </script>
</body>

</html>
